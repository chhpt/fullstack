# TCP

## TCP/IP åè®®

TCP/IP æ¨¡å‹æ˜¯ç”±å›½é™…æ ‡å‡† OSI æ¨¡å‹æ¼”åŒ–è€Œæ¥ï¼ŒTCP/IP æ¨¡å‹å°† OSI æ¨¡å‹ç”±ä¸ƒå±‚ç®€åŒ–ä¸ºäº”å±‚ï¼ˆä¸€å¼€å§‹ä¸ºå››å±‚ï¼‰ï¼Œåº”ç”¨å±‚ã€è¡¨ç¤ºå±‚ã€ä¼šè¯å±‚ç»Ÿä¸€ä¸ºåº”ç”¨å±‚ã€‚

TCP/IP åè®®è¢«ç§°ä¸ºä¼ è¾“æ§åˆ¶åè®®/äº’è”ç½‘åè®®ï¼Œåˆç§°ç½‘ç»œé€šè®¯åè®®(Transmission Control Protocol)ï¼Œæ˜¯ç”± `ç½‘ç»œå±‚` çš„ IP åè®®å’Œ `ä¼ è¾“å±‚` çš„ TCP åè®®ç»„æˆï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„åè®®é›†åˆã€‚

## TCP é“¾æ¥

### ä¸‰æ¬¡æ¡æ‰‹ å»ºç«‹è¿æ¥

TCPï¼ˆTransmission Control Protocolï¼Œä¼ è¾“æ§åˆ¶åè®®ï¼‰æ˜¯é¢å‘è¿æ¥çš„åè®®ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ”¶å‘æ•°æ®ä¹‹å‰ï¼Œå¿…é¡»å…ˆå’Œå¯¹æ–¹å»ºç«‹è¿æ¥ã€‚

ä¸€ä¸ª TCP è¿æ¥å¿…é¡»è¦ç»è¿‡ä¸‰æ¬¡ â€œå¯¹è¯â€ æ‰èƒ½å»ºç«‹èµ·æ¥ï¼Œå…¶ä¸­çš„è¿‡ç¨‹éå¸¸å¤æ‚ï¼Œåªç®€å•çš„æè¿°ä¸‹è¿™ä¸‰æ¬¡å¯¹è¯çš„ç®€å•è¿‡ç¨‹ï¼š

1. ä¸»æœº A å‘ä¸»æœº B å‘å‡ºè¿æ¥è¯·æ±‚æ•°æ®åŒ…ï¼šâ€œæˆ‘æƒ³ç»™ä½ å‘æ•°æ®ï¼Œå¯ä»¥å—ï¼Ÿâ€ï¼Œè¿™æ˜¯ç¬¬ä¸€æ¬¡å¯¹è¯ï¼›
2. ä¸»æœº B å‘ä¸»æœº A å‘é€åŒæ„è¿æ¥å’Œè¦æ±‚åŒæ­¥ ï¼ˆåŒæ­¥å°±æ˜¯ä¸¤å°ä¸»æœºä¸€ä¸ªåœ¨å‘é€ï¼Œä¸€ä¸ªåœ¨æ¥æ”¶ï¼Œåè°ƒå·¥ä½œï¼‰çš„æ•°æ®åŒ…ï¼šâ€œå¯ä»¥ï¼Œä½ ä»€ä¹ˆæ—¶å€™å‘ï¼Ÿâ€ï¼Œè¿™æ˜¯ç¬¬äºŒæ¬¡å¯¹è¯ï¼›
3. ä¸»æœº A å†å‘å‡ºä¸€ä¸ªæ•°æ®åŒ…ç¡®è®¤ä¸»æœº B çš„è¦æ±‚åŒ æ­¥ï¼šâ€œæˆ‘ç°åœ¨å°±å‘ï¼Œä½ æ¥ç€å§ï¼â€ï¼Œè¿™æ˜¯ç¬¬ä¸‰æ¬¡å¯¹è¯ã€‚

ä¸‰æ¬¡ â€œå¯¹è¯â€ çš„ç›®çš„æ˜¯ä½¿æ•°æ®åŒ…çš„å‘é€å’Œæ¥æ”¶åŒæ­¥ï¼Œç»è¿‡ä¸‰æ¬¡ â€œå¯¹è¯â€ ä¹‹åï¼Œä¸»æœº A æ‰å‘ä¸»æœº B æ­£å¼å‘é€æ•°æ®ã€‚

- ç¬¬ä¸€æ¬¡æ¡æ‰‹: å»ºç«‹è¿æ¥ã€‚å®¢æˆ·ç«¯å‘é€è¿æ¥è¯·æ±‚ï¼Œå‘é€ SYN æŠ¥æ–‡ï¼Œå°† seq è®¾ç½®ä¸º 0ã€‚ç„¶åï¼Œå®¢æˆ·ç«¯è¿›å…¥ SYN_SEND çŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤ã€‚
- ç¬¬äºŒæ¬¡æ¡æ‰‹: æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ SYN æŠ¥æ–‡æ®µã€‚éœ€è¦å¯¹è¿™ä¸ª SYN æŠ¥æ–‡æ®µè¿›è¡Œç¡®è®¤ï¼Œå‘é€ ACK æŠ¥æ–‡ï¼Œå°† ack è®¾ç½®ä¸º 1ã€‚åŒæ—¶ï¼Œè‡ªå·±è¿˜è¦å‘é€ SYN è¯·æ±‚ä¿¡æ¯ï¼Œå°† seq ä¸º 0ã€‚æœåŠ¡å™¨ç«¯å°†ä¸Šè¿°æ‰€æœ‰ä¿¡æ¯ä¸€å¹¶å‘é€ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶æœåŠ¡å™¨è¿›å…¥ SYN_RECV çŠ¶æ€ã€‚
- ç¬¬ä¸‰æ¬¡æ¡æ‰‹: å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨çš„ ACK å’Œ SYN æŠ¥æ–‡åï¼Œè¿›è¡Œç¡®è®¤ï¼Œç„¶åå°† ack è®¾ç½®ä¸º 1ï¼Œseq è®¾ç½®ä¸º 1ï¼Œå‘æœåŠ¡å™¨å‘é€ ACK æŠ¥æ–‡æ®µï¼Œè¿™ä¸ªæŠ¥æ–‡æ®µå‘é€å®Œæ¯•ä»¥åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½è¿›å…¥ ESTABLISHED çŠ¶æ€ï¼Œå®Œæˆ TCP ä¸‰æ¬¡æ¡æ‰‹ã€‚

### å››æ¬¡æŒ¥æ‰‹ é‡Šæ”¾è¿æ¥

å½“å®¢æˆ· A æ²¡æœ‰ä¸œè¥¿è¦å‘é€æ—¶å°±è¦é‡Šæ”¾ A è¿™è¾¹çš„è¿æ¥ï¼ŒA ä¼šå‘é€ä¸€ä¸ªæŠ¥æ–‡ï¼ˆæ²¡æœ‰æ•°æ®ï¼‰ï¼Œå…¶ä¸­ FIN è®¾ç½®ä¸º 1, æœåŠ¡å™¨ B æ”¶åˆ°åä¼šç»™åº”ç”¨ç¨‹åºä¸€ä¸ªä¿¡ï¼Œè¿™æ—¶ A é‚£è¾¹çš„è¿æ¥å·²ç»å…³é—­ï¼Œå³ A ä¸å†å‘é€ä¿¡æ¯ï¼ˆä½†ä»å¯æ¥æ”¶ä¿¡æ¯ï¼‰ã€‚ A æ”¶åˆ° B çš„ç¡®è®¤åè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç­‰å¾… B è¯·æ±‚é‡Šæ”¾è¿æ¥ï¼Œ B æ•°æ®å‘é€å®Œæˆåå°±å‘ A è¯·æ±‚è¿æ¥é‡Šæ”¾ï¼Œä¹Ÿæ˜¯ç”¨ FIN=1 è¡¨ç¤ºï¼Œ å¹¶ä¸”ç”¨ ack = u+1ï¼ŒA æ”¶åˆ°åå›å¤ä¸€ä¸ªç¡®è®¤ä¿¡æ¯ï¼Œå¹¶è¿›å…¥ TIME_WAIT çŠ¶æ€ï¼Œç­‰å¾… 2MSL æ—¶é—´ã€‚

- ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ª FIN æŠ¥æ–‡æ®µï¼Œå°†è®¾ç½® seq ä¸º 160 å’Œ ack ä¸º 112ï¼Œ; æ­¤æ—¶ï¼Œå®¢æˆ·ç«¯è¿›å…¥ FIN_WAIT_1 çŠ¶æ€, è¿™è¡¨ç¤ºå®¢æˆ·ç«¯æ²¡æœ‰æ•°æ®è¦å‘é€æœåŠ¡å™¨äº†ï¼Œè¯·æ±‚å…³é—­è¿æ¥;
- ç¬¬äºŒæ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡å™¨æ”¶åˆ°äº†å®¢æˆ·ç«¯å‘é€çš„ FIN æŠ¥æ–‡æ®µï¼Œå‘å®¢æˆ·ç«¯å›ä¸€ä¸ª ACK æŠ¥æ–‡æ®µï¼Œack è®¾ç½®ä¸º 1ï¼Œseq è®¾ç½®ä¸º 112; æœåŠ¡å™¨è¿›å…¥äº† CLOSE_WAIT çŠ¶æ€ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ ACK æŠ¥æ–‡åï¼Œè¿›å…¥ FIN_WAIT_2 çŠ¶æ€;
- ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹ï¼šæœåŠ¡å™¨ä¼šè§‚å¯Ÿè‡ªå·±æ˜¯å¦è¿˜æœ‰æ•°æ®æ²¡æœ‰å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœæœ‰ï¼Œå…ˆæŠŠæ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå†å‘é€ FIN æŠ¥æ–‡ï¼›å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ç›´æ¥å‘é€ FIN æŠ¥æ–‡ç»™å®¢æˆ·ç«¯ã€‚è¯·æ±‚å…³é—­è¿æ¥ï¼ŒåŒæ—¶æœåŠ¡å™¨è¿›å…¥ LAST_ACK çŠ¶æ€;
- ç¬¬å››æ¬¡æŒ¥æ‰‹ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨å‘é€çš„ FIN æŠ¥æ–‡æ®µï¼Œå‘æœåŠ¡å™¨å‘é€ ACK æŠ¥æ–‡æ®µï¼Œå°† seq è®¾ç½®ä¸º 161ï¼Œå°† ack è®¾ç½®ä¸º 113ï¼Œç„¶åå®¢æˆ·ç«¯è¿›å…¥ TIME_WAIT çŠ¶æ€; æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„ ACK æŠ¥æ–‡æ®µä»¥åï¼Œå°±å…³é—­è¿æ¥; æ­¤æ—¶ï¼Œå®¢æˆ·ç«¯ç­‰å¾… 2MSL åä¾ç„¶æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œåˆ™è¯æ˜ Server ç«¯å·²æ­£å¸¸å…³é—­ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥å…³é—­è¿æ¥äº†ã€‚

#### ğŸ“NOTE

> å…³äº TIME_WAIT è¿‡æ¸¡åˆ° CLOSED çŠ¶æ€è¯´æ˜ï¼šä» TIME_WAIT è¿›å…¥ CLOSED éœ€è¦ç»è¿‡ 2MSLï¼Œå…¶ä¸­ MSL å°±å«åš æœ€é•¿æŠ¥æ–‡æ®µå¯¿å‘½ï¼ˆMaxinum Segment Lifetimeï¼‰ï¼Œæ ¹æ® RFC 793 å»ºè®®è¯¥å€¼è¿™æ˜¯ä¸º 2 åˆ†é’Ÿï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦ç»è¿‡ 4 åˆ†é’Ÿï¼Œæ‰è¿›å…¥ CLOSED çŠ¶æ€ã€‚
>
> `ç¡®è®¤ ACK (Acknowlegemt)`ï¼šTCP åè®®è§„å®šï¼Œåªæœ‰ ACK=1 æ—¶æœ‰æ•ˆï¼Œä¹Ÿè§„å®šè¿æ¥å»ºç«‹åæ‰€æœ‰å‘é€çš„æŠ¥æ–‡çš„ ACK å¿…é¡»ä¸º 1
>
> `åŒæ­¥ SYN (SYNchronization)`ï¼šåœ¨è¿æ¥å»ºç«‹æ—¶ç”¨æ¥åŒæ­¥åºå·ã€‚å½“ SYN=1 è€Œ ACK=0 æ—¶ï¼Œè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªè¿æ¥è¯·æ±‚æŠ¥æ–‡ã€‚å¯¹æ–¹è‹¥åŒæ„å»ºç«‹è¿æ¥ï¼Œåˆ™åº”åœ¨å“åº”æŠ¥æ–‡ä¸­ä½¿ SYN=1 å’Œ ACK=1. å› æ­¤, SYN ç½® 1 å°±è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªè¿æ¥è¯·æ±‚æˆ–è¿æ¥æ¥å—æŠ¥æ–‡ã€‚
>
> `ç»ˆæ­¢ FIN (Finis)`ï¼šç”¨æ¥é‡Šæ”¾ä¸€ä¸ªè¿æ¥ã€‚å½“ FIN = 1 æ—¶ï¼Œè¡¨æ˜æ­¤æŠ¥æ–‡æ®µçš„å‘é€æ–¹çš„æ•°æ®å·²ç»å‘é€å®Œæ¯•ï¼Œå¹¶è¦æ±‚é‡Šæ”¾è¿æ¥ã€‚

![demo](./pics/tcp-ip-1.jpeg)


## TCP æµæ§åˆ¶

TODO: è¿›ä¸€æ­¥äº†è§£ 

http://mrpeak.cn/blog/tcp-flow-control00/
https://coolshell.cn/articles/11564.html
https://coolshell.cn/articles/11609.html

### ç›¸å…³æ–‡ç« 

- [æ·±å…¥ç†è§£ TCP/IP æ¨¡å‹](https://juejin.im/post/5a7c4ebaf265da4e81239431#heading-8)
- [TCP/IP åè®®è¯¦è§£](https://juejin.im/post/5a8bcdb1f265da4e865a7aca#heading-16)
- [é€šä¿—å¤§ç™½è¯æ¥ç†è§£ TCP åè®®çš„ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡åˆ†æ‰‹](https://github.com/jawil/blog/issues/14)