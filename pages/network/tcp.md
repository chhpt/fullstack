# TCP

## TCP/IP 协议

TCP/IP 模型是由国际标准 OSI 模型演化而来，TCP/IP 模型将 OSI 模型由七层简化为五层（一开始为四层），应用层、表示层、会话层统一为应用层。

TCP/IP 协议被称为传输控制协议/互联网协议，又称网络通讯协议(Transmission Control Protocol)，是由 `网络层` 的 IP 协议和 `传输层` 的 TCP 协议组成，是一个很大的协议集合。

## TCP 链接

### 三次握手 建立连接

TCP（Transmission Control Protocol，传输控制协议）是面向连接的协议，也就是说在收发数据之前，必须先和对方建立连接。

一个 TCP 连接必须要经过三次 “对话” 才能建立起来，其中的过程非常复杂，只简单的描述下这三次对话的简单过程：

1. 主机 A 向主机 B 发出连接请求数据包：“我想给你发数据，可以吗？”，这是第一次对话；
2. 主机 B 向主机 A 发送同意连接和要求同步 （同步就是两台主机一个在发送，一个在接收，协调工作）的数据包：“可以，你什么时候发？”，这是第二次对话；
3. 主机 A 再发出一个数据包确认主机 B 的要求同 步：“我现在就发，你接着吧！”，这是第三次对话。

三次 “对话” 的目的是使数据包的发送和接收同步，经过三次 “对话” 之后，主机 A 才向主机 B 正式发送数据。

- 第一次握手: 建立连接。客户端发送连接请求，发送 SYN 报文，将 seq 设置为 0。然后，客户端进入 SYN_SEND 状态，等待服务器的确认。
- 第二次握手: 服务器收到客户端的 SYN 报文段。需要对这个 SYN 报文段进行确认，发送 ACK 报文，将 ack 设置为 1。同时，自己还要发送 SYN 请求信息，将 seq 为 0。服务器端将上述所有信息一并发送给客户端，此时服务器进入 SYN_RECV 状态。
- 第三次握手: 客户端收到服务器的 ACK 和 SYN 报文后，进行确认，然后将 ack 设置为 1，seq 设置为 1，向服务器发送 ACK 报文段，这个报文段发送完毕以后，客户端和服务器端都进入 ESTABLISHED 状态，完成 TCP 三次握手。

### 四次挥手 释放连接

当客户 A 没有东西要发送时就要释放 A 这边的连接，A 会发送一个报文（没有数据），其中 FIN 设置为 1, 服务器 B 收到后会给应用程序一个信，这时 A 那边的连接已经关闭，即 A 不再发送信息（但仍可接收信息）。 A 收到 B 的确认后进入等待状态，等待 B 请求释放连接， B 数据发送完成后就向 A 请求连接释放，也是用 FIN=1 表示， 并且用 ack = u+1，A 收到后回复一个确认信息，并进入 TIME_WAIT 状态，等待 2MSL 时间。

- 第一次挥手：客户端向服务器发送一个 FIN 报文段，将设置 seq 为 160 和 ack 为 112，; 此时，客户端进入 FIN_WAIT_1 状态, 这表示客户端没有数据要发送服务器了，请求关闭连接;
- 第二次挥手：服务器收到了客户端发送的 FIN 报文段，向客户端回一个 ACK 报文段，ack 设置为 1，seq 设置为 112; 服务器进入了 CLOSE_WAIT 状态，客户端收到服务器返回的 ACK 报文后，进入 FIN_WAIT_2 状态;
- 第三次挥手：服务器会观察自己是否还有数据没有发送给客户端，如果有，先把数据发送给客户端，再发送 FIN 报文；如果没有，那么服务器直接发送 FIN 报文给客户端。请求关闭连接，同时服务器进入 LAST_ACK 状态;
- 第四次挥手：客户端收到服务器发送的 FIN 报文段，向服务器发送 ACK 报文段，将 seq 设置为 161，将 ack 设置为 113，然后客户端进入 TIME_WAIT 状态; 服务器收到客户端的 ACK 报文段以后，就关闭连接; 此时，客户端等待 2MSL 后依然没有收到回复，则证明 Server 端已正常关闭，客户端也可以关闭连接了。

#### 📝NOTE

> 关于 TIME_WAIT 过渡到 CLOSED 状态说明：从 TIME_WAIT 进入 CLOSED 需要经过 2MSL，其中 MSL 就叫做 最长报文段寿命（Maxinum Segment Lifetime），根据 RFC 793 建议该值这是为 2 分钟，也就是说需要经过 4 分钟，才进入 CLOSED 状态。
>
> `确认 ACK (Acknowlegemt)`：TCP 协议规定，只有 ACK=1 时有效，也规定连接建立后所有发送的报文的 ACK 必须为 1
>
> `同步 SYN (SYNchronization)`：在连接建立时用来同步序号。当 SYN=1 而 ACK=0 时，表明这是一个连接请求报文。对方若同意建立连接，则应在响应报文中使 SYN=1 和 ACK=1. 因此, SYN 置 1 就表示这是一个连接请求或连接接受报文。
>
> `终止 FIN (Finis)`：用来释放一个连接。当 FIN = 1 时，表明此报文段的发送方的数据已经发送完毕，并要求释放连接。

![demo](./pics/tcp-ip-1.jpeg)


## TCP 流控制

TODO: 进一步了解 

http://mrpeak.cn/blog/tcp-flow-control00/
https://coolshell.cn/articles/11564.html
https://coolshell.cn/articles/11609.html

### 相关文章

- [深入理解 TCP/IP 模型](https://juejin.im/post/5a7c4ebaf265da4e81239431#heading-8)
- [TCP/IP 协议详解](https://juejin.im/post/5a8bcdb1f265da4e865a7aca#heading-16)
- [通俗大白话来理解 TCP 协议的三次握手和四次分手](https://github.com/jawil/blog/issues/14)