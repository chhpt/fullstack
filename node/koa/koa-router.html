<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>koa-router | The Full Stack Way</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/the-full-stack-way/assets/css/0.styles.8a3e2982.css" as="style"><link rel="preload" href="/the-full-stack-way/assets/js/app.f9357a35.js" as="script"><link rel="preload" href="/the-full-stack-way/assets/js/2.b1f3daca.js" as="script"><link rel="preload" href="/the-full-stack-way/assets/js/91.a843ae09.js" as="script"><link rel="prefetch" href="/the-full-stack-way/assets/js/10.6c889a9a.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/100.f90f9973.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/101.3987eaff.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/102.3cf9c810.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/103.d15f6c9b.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/104.e466044e.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/105.20d1908f.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/106.5b39d446.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/107.fc8b496e.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/108.fb9f91e0.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/109.6268b8ea.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/11.7c8389bb.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/110.2c3d6f59.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/111.96ee1a2b.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/112.9128d190.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/113.15790c0b.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/114.31bfc42a.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/115.f4c92fe6.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/12.75a719dc.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/13.a8b6377a.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/14.6420038a.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/15.d1f13c21.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/16.00e6243c.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/17.35ac18ce.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/18.3c237a31.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/19.aabf4c6a.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/20.0986a2b7.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/21.e8c70f8b.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/22.741f5d73.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/23.ed34adbb.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/24.d62d4cc3.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/25.1b17f8e9.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/26.1ed597e5.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/27.ce30edde.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/28.139bf76b.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/29.f8ad8e1f.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/3.3f49bff2.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/30.a52c8169.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/31.2141d424.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/32.1b5b3ff5.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/33.5a737053.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/34.f26c31a5.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/35.915f7f61.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/36.59b2dcd7.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/37.c31c7f93.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/38.633d2a13.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/39.b694f183.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/4.0f03aa05.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/40.49ff0394.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/41.cde8809c.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/42.f9778ad2.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/43.41892a84.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/44.e7e8fe4e.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/45.3058bbf7.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/46.6be21497.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/47.0c007000.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/48.7e5b82ca.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/49.533c0c4b.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/5.447297a4.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/50.4d464cdb.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/51.96f40432.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/52.16b3b204.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/53.1b544a9a.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/54.0686f57d.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/55.fe2e21a5.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/56.64e0245a.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/57.1432a0f7.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/58.ef81beae.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/59.84426fc3.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/6.44cf4d9b.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/60.4fb23994.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/61.e19fe6bc.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/62.a517d9ff.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/63.82c9e9da.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/64.ddecf4eb.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/65.e96d2637.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/66.19075ca9.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/67.74248cbc.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/68.28058192.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/69.e7114145.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/7.4daee758.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/70.5fa684c4.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/71.077a147c.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/72.dcd1ef5d.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/73.e738e0f0.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/74.40c49915.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/75.b34fd6b0.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/76.89eca840.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/77.e0dcba02.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/78.eb97c178.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/79.39e665e3.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/8.51b0433f.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/80.f3777ec9.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/81.4ca8fadf.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/82.015a3b4f.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/83.1df7d2da.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/84.36b4c86e.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/85.7bd7d160.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/86.0a205a19.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/87.3d08f039.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/88.e152f51c.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/89.02bed3c5.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/9.80cef23a.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/90.df6e336b.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/92.c5b0c9f9.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/93.9f096ef1.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/94.50f0152f.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/95.ef3c1556.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/96.615d21c1.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/97.7867466b.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/98.3a9d0ecd.js"><link rel="prefetch" href="/the-full-stack-way/assets/js/99.cece1fc3.js">
    <link rel="stylesheet" href="/the-full-stack-way/assets/css/0.styles.8a3e2982.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/the-full-stack-way/" class="home-link router-link-active"><!----> <span class="site-name">The Full Stack Way</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/the-full-stack-way/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/the-full-stack-way/data-structure-and-algorithms/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/operating-system/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/network/" class="nav-link">
  网络
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web 前端" class="dropdown-title"><span class="title">Web 前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/the-full-stack-way/html&amp;css/" class="nav-link">
  HTML&amp;CSS
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/engineering/" class="nav-link">
  工程化
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/mini-program/" class="nav-link">
  小程序
</a></li></ul></div></div><div class="nav-item"><a href="/the-full-stack-way/node/" class="nav-link router-link-active">
  Node
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/the-full-stack-way/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/the-full-stack-way/docker/" class="nav-link">
  Docker
</a></div><div class="nav-item"><a href="/the-full-stack-way/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/chhpt/the-full-stack-way" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/the-full-stack-way/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><span class="title">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/the-full-stack-way/data-structure-and-algorithms/" class="nav-link">
  数据结构与算法
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/operating-system/" class="nav-link">
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/network/" class="nav-link">
  网络
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web 前端" class="dropdown-title"><span class="title">Web 前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/the-full-stack-way/html&amp;css/" class="nav-link">
  HTML&amp;CSS
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/javascript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/engineering/" class="nav-link">
  工程化
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/react/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/the-full-stack-way/mini-program/" class="nav-link">
  小程序
</a></li></ul></div></div><div class="nav-item"><a href="/the-full-stack-way/node/" class="nav-link router-link-active">
  Node
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/the-full-stack-way/redis/" class="nav-link">
  Redis
</a></li></ul></div></div><div class="nav-item"><a href="/the-full-stack-way/docker/" class="nav-link">
  Docker
</a></div><div class="nav-item"><a href="/the-full-stack-way/tools/" class="nav-link">
  工具
</a></div><div class="nav-item"><a href="https://github.com/chhpt/the-full-stack-way" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/the-full-stack-way/node/" class="sidebar-link">Node 简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/#全局对象" class="sidebar-link">全局对象</a></li></ul></li><li><a href="/the-full-stack-way/node/module.html" class="sidebar-link">模块</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/module.html#模块的实现" class="sidebar-link">模块的实现</a></li></ul></li><li><a href="/the-full-stack-way/node/npm.html" class="sidebar-link">NPM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/npm.html#some-projects" class="sidebar-link">some projects</a></li><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/npm.html#一些有趣的包" class="sidebar-link">一些有趣的包</a></li></ul></li><li><a href="/the-full-stack-way/node/event-loop.html" class="sidebar-link">事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/event-loop.html#任务队列" class="sidebar-link">任务队列</a></li></ul></li><li><a href="/the-full-stack-way/node/v8.html" class="sidebar-link">V8</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/v8.html#内存限制" class="sidebar-link">内存限制</a></li><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/v8.html#对象分配" class="sidebar-link">对象分配</a></li><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/v8.html#垃圾回收算法" class="sidebar-link">垃圾回收算法</a></li></ul></li><li><a href="/the-full-stack-way/node/stream.html" class="sidebar-link">Stream</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/stream.html#流是什么" class="sidebar-link">流是什么</a></li><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/stream.html#流的分类" class="sidebar-link">流的分类</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Koa</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/the-full-stack-way/node/koa/koa.html" class="sidebar-link">Koa</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/koa/koa.html#application-js" class="sidebar-link">application.js</a></li></ul></li><li><a href="/the-full-stack-way/node/koa/koa-router.html" class="active sidebar-link">koa-router</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/koa/koa-router.html#api" class="sidebar-link">API</a></li><li class="sidebar-sub-header"><a href="/the-full-stack-way/node/koa/koa-router.html#原理" class="sidebar-link">原理</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="koa-router"><a href="#koa-router" class="header-anchor">#</a> koa-router</h1> <h2 id="api"><a href="#api" class="header-anchor">#</a> API</h2> <p>koa-router 是 Koa 的路由中间件，基本使用方法和其他中间件一致。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ctx.router available</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="处理请求"><a href="#处理请求" class="header-anchor">#</a> 处理请求</h3> <p>koa-router 支持 <code>get|put|post|patch|delete|del</code> 等 HTTP 动作，并且在使用时支持链式调用</p> <div class="language-js extra-class"><pre class="language-js"><code>router
  <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="命名路由"><a href="#命名路由" class="header-anchor">#</a> 命名路由</h3> <p>koa-router 支持为路由提供名字，方便精确定位到路由，以便在开发过程中修改路由的 url</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'/users/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 修改 url</span>
router<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// =&gt; &quot;/users/3&quot;</span>
</code></pre></div><h3 id="多中间件"><a href="#多中间件" class="header-anchor">#</a> 多中间件</h3> <p>koa-router 支持  为同一个路由提供多个  中间件，可以进行多重处理</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token string">'/users/:id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// =&gt; { id: 17, name: &quot;Alex&quot; }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="嵌套路由"><a href="#嵌套路由" class="header-anchor">#</a> 嵌套路由</h3> <p>koa-router 支持  路由市里的嵌套使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> forums <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> posts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

posts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
posts<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:pid'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
forums<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/forums/:fid/posts'</span><span class="token punctuation">,</span> posts<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> posts<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// responds to &quot;/forums/123/posts&quot; and &quot;/forums/123/posts/123&quot;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>forums<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="路由前缀-prefix"><a href="#路由前缀-prefix" class="header-anchor">#</a> 路由前缀(prefix)</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  prefix<span class="token operator">:</span> <span class="token string">'/users'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// responds to &quot;/users&quot;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// responds to &quot;/users/:id&quot;</span>
</code></pre></div><h3 id="路由参数"><a href="#路由参数" class="header-anchor">#</a> 路由参数</h3> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:category/:title'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// =&gt; { category: 'programming', title: 'how-to-node' }</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h3> <h4 id="router-routes-function"><a href="#router-routes-function" class="header-anchor">#</a> router.routes =&gt; function</h4> <p>返回匹配路由的所有中间件。</p> <h4 id="router-use-path-middleware-router"><a href="#router-use-path-middleware-router" class="header-anchor">#</a> router.use([path], middleware) =&gt; Router</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// session middleware will run before authorize</span>
router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">authorize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// use middleware only with given path</span>
router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token function">userAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// or with an array of paths</span>
router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token string">'/admin'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">userAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h2> <p>首先，我们需要明白路由器(router)在后台服务中作用。作为提供资源的一方，服务器会接受大量的请求，不同的请求会期望返回不同的资源，而路由器担任着划分请求的功能，将不同类的请求分配给不同的服务单元处理，使得不同的服务单元可以各司其职，降低应用的复杂度。</p> <p>路由器的核心就是根据不同的请求调用不同的处理逻辑，所以路由器的功能可以简单划分成两点：划分请求与调用处理逻辑。当然，复杂的路由器可能也会有其他功能，这里不做过多讨论。</p> <p><code>koa-router</code> 作为 koa 的路由器中间件，主要也承担了以上两个责任，我们可以看 <code>koa-router</code> 的常用 API</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码可以这么理解：当接受到 <code>GET &quot;/api&quot;</code> 请求时，调用 <code>(ctx, next) =&gt; {}</code> 进行处理，这就是路由器的核心：分发请求。当然 <code>koa-router</code> 这个框架比较强大，也提供了许多其他功能，这个要放到后面再说，当前的任务是理解 <code>koa-router</code> 的核心，理解怎么分发请求。</p> <h3 id="为请求指定处理逻辑"><a href="#为请求指定处理逻辑" class="header-anchor">#</a> 为请求指定处理逻辑</h3> <p><code>koa-router</code> 使用了原型模拟类， 并在原型上定义了一系列方法，<code>router</code> 实例暴露的 <code>get|put|post|patch|delete|del</code> 等方法就是定义在原型上的。<code>get|put|post|patch|delete|del</code> 等方法的作用是指定请求的处理逻辑，当我们新建 <code>router</code> 实例之后，就需要对不同的请求，也叫做路由(route)添加不同的处理逻辑</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>那么，当我们添加处理逻辑时，发生了什么呢，让我们看看 <code>koa-router</code> 的源码：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Router<span class="token punctuation">;</span>
<span class="token comment">// koa-router 导出的构造函数</span>
<span class="token keyword">function</span> <span class="token function">Router</span><span class="token punctuation">(</span><span class="token parameter">opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Router</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>methods <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>methods <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token string">'HEAD'</span><span class="token punctuation">,</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">,</span> <span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span> <span class="token string">'PATCH'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'DELETE'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先，<code>koa-router</code> 导出了一个构造函数，就是常用的 <code>Router</code>，通过 new 生成 router 实例进行使用。我们接着往下看，可以发现这样一段代码</p> <div class="language-js extra-class"><pre class="language-js"><code>methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里有一个 methods 数组，顶部有一行声明 <code>var methods = require('methods');</code>，可以看出 methods 是这个 <code>methods</code> 的默认导出，我们可以到 <a href="https://github.com/jshttp/methods" target="_blank" rel="noopener noreferrer">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 上看看这个 methods 的介绍</p> <blockquote><p>HTTP verbs that Node.js core's HTTP parser supports.</p></blockquote> <p>介绍简单明了，就是 Node 中的 HTTP 解析器支持的 HTTP 动词，诸如 <code>GET</code>， <code>POST</code> 等，了解这个之后我们就可以继续往下看了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// methods 包含 HTTP 动词的数组</span>
methods<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> path<span class="token punctuation">,</span> middleware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> middleware<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">||</span> path <span class="token keyword">instanceof</span> <span class="token class-name">RegExp</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      middleware <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      middleware <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      path <span class="token operator">=</span> name<span class="token punctuation">;</span>
      name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 调用 register 方法</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> name
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// this 即 router 实例，使得可以链式调用 get 等方法</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这段代码对 <code>methods</code> 进行遍历，并且在 Router 的原型上添加了 <code>[method]</code> 方法，也就是我们前面使用的 <code>router.get()</code> 等方法。<code>[method]</code> 方法接受 <code>name</code>，<code>path</code>，<code>middleware</code> 三个参数，从 <code>koa-router</code> 的 API 文档中可以得知 <code>name</code> 参数是可选的，代表着路由的名称，<code>path</code> 就是路由的请求 url，<code>middleware</code> 就是处理请求的函数，<code>koa-router</code> 允许我们对一个路由指定多个处理方法，从代码可以看到，<code>koa-router</code> 会通过函数的 arguments 参数获取所有的处理函数，并存到 middleware 变量中，然后会调用 <code>register</code> 方法对路由进行处理，这个 <code>register</code> 后面再看。这里提一下这个最后返回的 <code>this</code>，这里的 <code>this</code> 会指向 <code>router</code> 实例，这样做的目的是实现 get 等方法的链式调用，可以一次处理多个路由</p> <div class="language-js extra-class"><pre class="language-js"><code>router
  <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>顺着函数的执行顺序，我们继续看看 <code>register</code> 方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建并注册路由</span>
<span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">register</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 包含路由名</span>
  opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> stack <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stack<span class="token punctuation">;</span> <span class="token comment">// []</span>

  <span class="token comment">// 支持 path 数组</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      router<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> p<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建路由对象，保存路由信息</span>
  <span class="token keyword">var</span> route <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Layer</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> middleware<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    end<span class="token operator">:</span> opts<span class="token punctuation">.</span>end <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">?</span> opts<span class="token punctuation">.</span>end <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> opts<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    sensitive<span class="token operator">:</span> opts<span class="token punctuation">.</span>sensitive <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>sensitive <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    strict<span class="token operator">:</span> opts<span class="token punctuation">.</span>strict <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>strict <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    prefix<span class="token operator">:</span> opts<span class="token punctuation">.</span>prefix <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>prefix <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    ignoreCaptures<span class="token operator">:</span> opts<span class="token punctuation">.</span>ignoreCaptures
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 为路由的添加 prefix</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span><span class="token function">setPrefix</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>opts<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 添加 param</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    route<span class="token punctuation">.</span><span class="token function">param</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>params<span class="token punctuation">[</span>param<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> route<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>register</code> 方法</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2019-03-29 07:01:41</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/the-full-stack-way/node/koa/koa.html" class="prev">
        Koa
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/the-full-stack-way/assets/js/app.f9357a35.js" defer></script><script src="/the-full-stack-way/assets/js/2.b1f3daca.js" defer></script><script src="/the-full-stack-way/assets/js/91.a843ae09.js" defer></script>
  </body>
</html>
